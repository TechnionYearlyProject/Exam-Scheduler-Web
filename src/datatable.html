<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="datatable.css">
    <meta charset="UTF-8">
</head>
<body>
<input type="text" id="search_box" style="height: 30px; width: 439px; font-size: 13px; outline: none; border-color: rgba(0,0,0,.12); border-width: 1px; border-bottom-width: 0px; padding-right: 4px;" placeholder="חיפוש קורסים...">
<table id="example" class="mdl-data-table" style="max-width:420px; min-width: 420px; table-layout: fixed">
    <thead style="padding-left: 0px;">
    <tr>
        <th></th>
        <th style="padding-left: 0px">מספר</th>
        <th>שם הקורס</th>
        <th style="padding-left: 0px">העדפה</th>
        <th style="padding-left: 0px">למידה</th>
    </tr>
    </thead>
</table>




<script type="module">
    import { sendRequest } from './js/request';
    function course_expand (row) {
        let row_changer = function (row, field, value) {
          return function(){
              var d1 = row.data();
              d1[field] = value;
              row.data(d1);
              save_changes_to_local(d1.id, field, value);
          }
        };
        let entry = get_course_entry(row.data().id);
        let has_exam = '';
        if (entry["has_exam"] == true)
            has_exam = 'checked';
        var mini_table = document.createElement('table');
        mini_table.style = "padding-left:50px; border: 0px ; cellspacing: 0px; cellpadding: 5px";
        var pairs = [];
        var switcher = document.createElement("label");
        switcher.className = "switch";
        switcher.style = "margin-bottom: -2px; display: inline-block";
        switcher.innerHTML = '<input type="checkbox" id="has_exam_checker_' + entry.id + '" ' + has_exam + '>\n' +
            '<span class="slider round"></span>\n';
        pairs.push({text: 'שבץ בלוח המבחנים:', elem: switcher, elem_is_text: false});
        pairs.push({text: 'פקולטה:', elem: entry["faculty"], elem_is_text: true});
        pairs.push({text: 'נקודות זכות:', elem: entry['credit_points'], elem_is_text: true});
        var input = document.createElement("input");
        input.value = entry["days_before"];
        input.className = "form-control";
        input.setAttribute("type", "number");
        input.setAttribute("min", "0");
        input.setAttribute("step", "1");
        input.style = "padding-right: 2px; padding-left: 0px; border-color: #6c757d; font-size: 13px; height: 20px; width: 58px;border-radius: 0.2rem;";
        input.onchange = function(){
            save_changes_to_local(entry.id, "preparationTime", input.value);
        };
        pairs.push({text: 'ימי למידה:', elem: input, elem_is_text: false});
        var button_group = document.createElement('div');
        button_group. className = 'btn-group btn-group-toggle';
        button_group.setAttribute('data-toggle','buttons');
        var start_button = document.createElement('label');
        start_button.className = "btn btn-outline-secondary";
        start_button.innerHTML = '<input type="radio" name="options" id="start" autocomplete="off"> התחלה\n';
        start_button.style = "height: 20px; width: 58px; padding: 0px; font-size: 13px; border-top-right-radius: 0.2rem; border-bottom-right-radius: 0.2rem;"
        start_button.onclick = row_changer(row, "pref", "התחלה");
        var auto_button = document.createElement('label');
        auto_button.className = "btn btn-outline-secondary active";
        auto_button.innerHTML = '<input type="radio" name="options" id="start" autocomplete="off"> אוטומטי\n';
        auto_button.checked = "true";
        auto_button.style = "height: 20px; width: 58px; padding: 0px; font-size: 13px;"
        auto_button.onclick = row_changer(row, "pref", "אוטומטי" );
        var end_button = document.createElement('label');
        end_button.className = "btn btn-outline-secondary";
        end_button.innerHTML = '<input type="radio" name="options" id="start" autocomplete="off"> סוף\n';
        end_button.style = "height: 20px; width: 58px; padding: 0px; font-size: 13px; border-top-left-radius: 0.2rem; border-bottom-left-radius: 0.2rem;"
        end_button.onclick = row_changer(row, "pref", "סוף" );
        if (entry["is_first"]) {
            auto_button.className = "btn btn-outline-secondary";
            auto_button.checked = "false";
            end_button.className = "btn btn-outline-secondary";
            end_button.checked = "false";
            start_button.className = "btn btn-outline-secondary active";
            start_button.checked = "true";
        }
        if (entry["is_last"]) {
            auto_button.className = "btn btn-outline-secondary";
            auto_button.checked = "false";
            start_button.className = "btn btn-outline-secondary";
            start_button.checked = "false";
            end_button.className = "btn btn-outline-secondary active";
            end_button.checked = "true";
        }
        button_group.appendChild(start_button);
        button_group.appendChild(auto_button);
        button_group.appendChild(end_button);
        pairs.push({text: 'העדפת שיבוץ:', elem: button_group, elem_is_text: false});
        var conbutton = document.createElement("button");
        conbutton.type = "button";
        conbutton.className = "btn btn-outline-secondary btn-sm";
        conbutton.style = "height: 20px; width: 20px; padding: 0px;"
        conbutton.innerHTML = '<i class="fas fa-link"></i>';
        conbutton.onclick = function() {
            var title = document.getElementById("conflicts_title");
            title.innerHTML = 'ניהול קשרים עבור הקורס "' + entry["name"] + '"';
            var table1 = $("#all_courses").DataTable();
            var table2 = $("#conflicting_courses").DataTable();
            table2.clear().draw();
            $('#conflicts_modal').modal();
        };
        pairs.push({text: 'ניהול קשרים:', elem: conbutton, elem_is_text: false});
        var delbutton = document.createElement("button");
        delbutton.type = "button";
        delbutton.className = "btn btn-outline-secondary btn-sm";
        delbutton.style = "height: 20px; width: 20px; padding: 0px;"
        delbutton.innerHTML = '<i class="fas fa-trash"></i>';
        delbutton.onclick = function() {
            function del() {
                row.remove();
                row.node().parentNode.removeChild(row.node());
            };
            popup_modal("CONF", 'האם אתה בטוח שברצונך למחוק את הקורס "' + entry["name"] +'"?', del);
        };
        pairs.push({text: 'מחיקת הקורס:', elem: delbutton, elem_is_text: false});
        for (var i in pairs) {
            var td1 = document.createElement("td");
            td1.style = "border-color: transparent !important; padding-bottom: 5px; padding-top:1px;";
            td1.innerHTML = pairs[i].text;
            var td2 = document.createElement("td");
            td2.style = "border-color: transparent !important; padding-bottom: 5px; padding-top:1px;";
            if (pairs[i].elem_is_text)
                td2.innerHTML = pairs[i].elem;
            else
                td2.appendChild(pairs[i].elem);
            var tr = document.createElement("tr");
            tr.appendChild(td1);
            tr.appendChild(td2);
            mini_table.appendChild(tr);
        }
        row.child(mini_table).show();
        $("[id^='has_exam_checker']").click(function () {
            let id = $(this).attr('id').split("_").pop();
            save_changes_to_local(id, "has_exam", $(this).is(":checked"));
        });
    }

    $(document).ready(function() {
        localStorage.setItem(changes_root_key, "{}");
        var table = $('#example').DataTable( {
            scrollY: 540,
            paging: false,
            info: false,
            "dom": 'lrt',
            "language":  {
              "emptyTable": "טוען רשימת קורסים...",
                "zeroRecords": "לא נמצאו קורסים מתאימים",
            },
            "columnDefs": [
                { "width": "25px", "targets": 0 },
                { "width": "75px", "targets": 1 },
                { "width": "75px", "targets": 3 },
                { "width": "70px", "targets": 4 },
            ],
            "columns": [
                {
                    "className":      'details-control',
                    "orderable":      false,
                    "data":           null,
                    "defaultContent": '',
                    "render": function () {
                        return '<i class="fas fa-angle-down"></i>';
                    },
                },
                { "data": "id" },
                { "data": "name" },
                { "data": "pref" },
                { "data": "days_before" }
            ],
            "order": [[1, 'asc']]
        } );
        $('#example tbody').on('click', 'td.details-control', function () {
            var tr = $(this).closest('tr');
            var tdi = tr.find("i.fas");
            var row = table.row( tr );
            if ( row.child.isShown() ) {
                row.child.hide();
                tr.removeClass('shown');
                tdi.first().removeClass('fa-angle-up');
                tdi.first().addClass('fa-angle-down');
            }
            else {
                course_expand(row);
                tr.addClass('shown');
                tdi.first().removeClass('fa-angle-down');
                tdi.first().addClass('fa-angle-up');
            }
        }
        );
        $('#search_box').keyup(function(){
            table.search($(this).val()).draw() ;
        })
    } );
</script>
</body>
</html>