<!DOCTYPE html>
<html lang="en">
<head>
  <script src="resources/jquery-3.3.1.js"></script>
  <link rel="stylesheet" href="resources/bootstrap.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.12/css/all.css" integrity="sha384-G0fIWCsCzJIMAVNQPfjH08cyYaUtMwjJwqiRKxxE/rx96Uroj1BtIQ6MLJuheaO9" crossorigin="anonymous">
  <link rel="stylesheet" href="resources/bootstrap-rtl.css">
  <link rel="stylesheet" href="styles.css">
  <script src="resources/bootstrap.js"></script>
  <link rel="shortcut icon" type="image/png" href="graphics/favicon.ico"/>
  <meta charset="utf-8">
  <title>Technion Exam Scheduler</title>
</head>
<body style="overflow-x: hidden;" id="login_body">
<nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #343a40; padding: 0px; height: 59px;">
  <span class="navbar-brand mb-0 h1" style="margin-left: 20px; font-size: 22px;">מערכת שיבוץ לוח מבחנים</span>
</nav>
<div class="container" id="faculties_grid" style="padding-top: 40px;">
</div>
<script type="module">
    import { sendRequest } from './js/request';
    import { setCookie } from './js/cookie';
    function getFaculties() {
        sendRequest('GET', '/api/faculty/list', null, function (res) {
            var faculties_grid = document.getElementById('faculties_grid');
            var faculties = JSON.parse(res);
            var row = document.createElement("div");
            row.className = "row justify-content-md-center";
            row.style = "padding-top: 20px; padding-bottom: 20px;";
            for (var i in faculties) {
                let name = faculties[i].name;
                if (name == "Administrator") {
                    name = "לימודי הסמכה"
                }
                let id = i;
                var modal = document.createElement("div");
                modal.innerHTML = '<div class="modal fade" id="user_modal_' + id + '" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">\n' +
                    '  <div class="modal-dialog modal-dialog-centered" role="document">\n' +
                    '    <div class="modal-content">\n' +
                    '      <div class="modal-header">\n' +
                    '        <h5 class="modal-title" id="exampleModalLongTitle">התחברות</h5>\n' +
                    '      </div>\n' +
                    '      <div class="modal-body" align="center" style="height: 305px;">\n' +
                    '<img src="' + faculties[i].image + '"style="border-radius: 50%; height: 120px; width: 120px;">\n' +
                    '                  <div style="text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px; font-weight: bold;">\n' +
                    name +
                    '                  </div>' +
                    '<input type="password" class="form-control" id="user_password_' + id + '" placeholder="הזן סיסמה" style="margin-top:10px; margin-bottom: 10px; width: 100% !important; font-size: 14px;">\n' +
                    '                  <button type="button" class="btn btn-secondary btn-md" id="user_button_' + id + '" style="width: 100%; font-size: 14px;" onclick="myFunction()">\n' +
                    '                      התחבר\n' +
                    '                  </button>' +
                    '            <div class="alert alert-danger col-sm-12" id="user_error_' + id + '" style="padding-top: 6px; padding-bottom: 6px; margin-bottom: 0px; margin-top: 10px; text-align: right; display: none; font-size: 14px;">הסיסמה שגויה</div>\n' +
                    '      </div>\n' +
                    '    </div>\n' +
                    '  </div>\n' +
                    '</div>';
                document.getElementById("login_body").appendChild(modal);
                var user = document.createElement("div");
                user.className = "col-md-auto";
                user.style.paddingLeft = "25px";
                user.style.paddingRight = "25px";
                user.style.cursor = "pointer";
                user.onmouseover = function () {
                    this.style.opacity = ".7";
                };
                user.onmouseout = function () {
                    this.style.opacity = "1";
                };
                user.onclick = function () {
                    $('#user_modal_' + id).modal();
                };
                var lbl = document.createElement("div");
                lbl.innerHTML = name;
                lbl.style = "text-align: center; width:120px;  overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px; font-weight: bold;";
                var img = document.createElement("img");
                img.src = faculties[i].image;
                img.style = "border-radius: 50%; height: 120px; width: 120px;";
                user.appendChild(img);
                user.appendChild(lbl);
                row.appendChild(user);
                if (parseInt(i) % 5 == 4) {
                    faculties_grid.appendChild(row);
                    row = document.createElement("div");
                    row.className = "row justify-content-md-center";
                    row.style = "padding-top: 15px; padding-bottom: 15px;";
                } else {
                    faculties_grid.appendChild(row);
                }
                document.getElementById('user_button_' + id).onclick = function (e) {
                    login(faculties[id].name, document.getElementById('user_password_' + id).value, document.getElementById('user_error_' + id),faculties[id].image);
                };
                document.getElementById('user_password_' + id).onkeydown = function (e) {
                    if (e.keyCode == 13) {
                        login(faculties[id].name, document.getElementById('user_password_' + id).value, document.getElementById('user_error_' + id), faculties[id].image);
                    } else {
                        document.getElementById('user_error_' + id).style.display = 'none';
                    }
                };
            }
        });
    }
    function login(name, password, error, image) {
        error.style.display = 'none';
        let json = {"name": name, "password": password};
        sendRequest('POST', '/api/login', json, function (res) {
            let data = JSON.parse(res);
            if (data.auth) {
                console.log(data);
                setCookie('token', data.token);
                setCookie('faculty', data.username);
                localStorage.setItem('faculty_name', name);
                localStorage.setItem('faculty_image', image);
                window.location.href = "/scheduler";
            } else {
                error.style.display = 'block';
            }
        })
    }
    window.addEventListener('load', getFaculties, false);
    $("#login_form").submit (function (e) {
        e.preventDefault();
        login();
    });
</script>
</body>
</html>