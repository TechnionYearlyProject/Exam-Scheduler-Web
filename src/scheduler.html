<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-lite/1.1.0/material.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/dataTables.material.min.css">
    <script src="resources/jquery-3.3.1.js"></script>
    <link rel="stylesheet" href="resources/bootstrap.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.12/css/all.css" integrity="sha384-G0fIWCsCzJIMAVNQPfjH08cyYaUtMwjJwqiRKxxE/rx96Uroj1BtIQ6MLJuheaO9" crossorigin="anonymous">
    <link rel="stylesheet" href="resources/bootstrap-rtl.css">
    <script src="umd/popper.js"></script>
    <script src="resources/bootstrap.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker3.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/locales/bootstrap-datepicker.he.min.js"></script>
    <link rel="shortcut icon" type="image/png" href="graphics/favicon.ico"/>
    <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.16/js/dataTables.material.min.js"></script>
    <script type="text/javascript" src="funcs.js"></script>
    <link rel="stylesheet" href="styles.css">
    <meta charset="utf-8">
    <title>Technion Exam Scheduler</title>
</head>
<body style="overflow-x: hidden;">
<div id="toolbar"></div>
<div class="dropdown navbar" style="padding-right: 15px; padding-left: 15px;">
    <label class="dropdown-toggle" id="semester_button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-weight: bold; font-size: 32px; padding-right: 16px; padding-top: 10px;"></label>
    <div id= "sem_picker" class="dropdown-menu" aria-labelledby="semester_button" style="width: 350px; margin-top: -5px;"></div>
    <div>
        <div class="btn-group">
            <button type="button" class="btn btn-secondary btn-md" style="height: 40px; width: 110px; margin-left: 5px;" id="scheduler_function_caller">
                <i class="fas fa-calendar-alt" style="padding-left: 5px"></i>
                שיבוץ
            </button>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-secondary btn-md" style="height: 40px; width: 110px; margin-left: 5px;" id="schedule_clear">
                <i class="fas fa-trash-alt" style="padding-left: 5px"></i>
                ניקוי
            </button>
        </div>
    </div>
</div>
<div class="form-group row" style="text-align: right; padding-right: 50px; padding-left: 50px; padding-top: 0px; margin-top: 0px !important;">
  <div class="container-fluid col">
    <div id="courses"></div>
  </div>
  <div class="container-fluid col">
    <div id="moed_a" moed="a"></div>
  </div>
  <div class="container-fluid col">
    <div id="moed_b" moed="b"></div>
  </div>
</div>

<div id="popover_comment" class="modal fade">
    <div class = "row">
        <div class="col 9" style="padding-left: 0px; padding-right: 11px"><textarea id="popover_input" rows = "2" type="text" style="resize: none;  font-size: 13px" class="form-control"></textarea></div>
        <div class="col-3" style="padding-left: 11px; padding-right: 7px"><button id="popover_button" class="btn btn-secondary" style=" ont-size: 13px; height: 100%; width: 100%;"><i class="fas fa-flag"></i></button></div>
    </div>
</div>

<div class="modal fade" data-backdrop="false" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document" style="margin-top: 90px;">
        <div class="modal-content" style="width: 440px;">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">בונה לוחות מבחנים</h5>
            </div>
            <div class="modal-body" align="center">
                <img src="graphics/load.gif">
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="alert_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" style="padding-top: 4px; padding-bottom: 4px; align-items: center !important; justify-content: unset">
                <span id="alert_icon" style="font-size: 30px;"></span>
                <h5 class="modal-title" style="margin-right: 5px;" id="alert_title"></h5>
            </div>
            <div class="modal-body" id="alert_body" style="text-align: right; height: 80px;"></div>
            <div class="modal-footer" id="alert_buttons" style="padding: 10px;">
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { sendRequest } from './js/request';
    var map_a = {};
    var map_b = {};
    var dict = [];
    sendRequest('GET', '/api/semester/list', null, function (res) {
        let semesters = JSON.parse(res);
        for (let i = semesters.length - 1; i >= 0; i--) {
            let semester = semesters[i].semester;
            if (semester == "spring") {
                semester = "אביב ";
            } else {
                semester = "חורף ";
            }
            let year = semesters[i].year.toString();
            let a = document.createElement("a");
            a.className = "dropdown-item";
            a.href = "#";
            a.innerHTML = 'סמסטר ' + semester + year + ' ';
            a.setAttribute('semester_name', semesters[i].year + '-' + semesters[i].semester);
            a.setAttribute('start_a', semesters[i].start_a);
            a.setAttribute('end_a', semesters[i].end_a);
            a.setAttribute('start_b', semesters[i].start_b);
            a.setAttribute('end_b', semesters[i].end_b);
            a.onclick = function () {
                document.getElementById('semester_button').innerHTML = a.innerHTML;
                localStorage.setItem('start_a', a.getAttribute('start_a'));
                localStorage.setItem('end_a', a.getAttribute('end_a'));
                localStorage.setItem('start_b', a.getAttribute('start_b'));
                localStorage.setItem('end_b', a.getAttribute('end_b'));
                localStorage.setItem('semester_name', a.getAttribute('semester_name'));
                map_a = make_calendar(new Date(a.getAttribute('start_a')), new Date(a.getAttribute('end_a')), "a");
                map_b = make_calendar(new Date(a.getAttribute('start_b')), new Date(a.getAttribute('end_b')), "b");
                load_courses_table();
            };
            document.getElementById('sem_picker').appendChild(a);
        }
        var top = document.getElementById('sem_picker').firstChild;
        document.getElementById('semester_button').innerHTML = top.innerHTML;
        localStorage.setItem('start_a', top.getAttribute('start_a'));
        localStorage.setItem('end_a', top.getAttribute('end_a'));
        localStorage.setItem('start_b', top.getAttribute('start_b'));
        localStorage.setItem('end_b', top.getAttribute('end_b'));
        localStorage.setItem('semester_name', top.getAttribute('semester_name'));
        map_a = make_calendar(new Date(top.getAttribute('start_a')), new Date(top.getAttribute('end_a')), "a");
        map_b = make_calendar(new Date(top.getAttribute('start_b')), new Date(top.getAttribute('end_b')), "b");
        load_courses_table();
    });
    var fillScheduleWithCourses = function (moeds) {
        return function (result) {
            result = JSON.parse(result);
            console.log(result);
            for (var m = 0; m < moeds.length; m++){
                var moed = moeds[m];
                for(var i = 0; i < result[moed].schedule.length; i++){
                    var examDay = result[moed].schedule[i];
                    var day = moed +'_day_' + examDay.index;
                    var day_elem = document.getElementById(day);
                    for (var j = 0; j < examDay.exams.length; j++){
                        var test = create_test(day_elem, "div", examDay.exams[j]["name"], examDay.exams[j]["id"], "test", moed);
                    }
                }
            }
        }
    };
    $(function () {
        $('[data-toggle="tooltip"]').tooltip()
    })
    $('body').on('click', function (e) {
        if (e.target.className == "popover-body" || e.target.id == "popover_input" || e.target.id == "popover_button")
            return;
        $('[data-toggle="popover"]').each(function () {
            $(this).popover('hide');
        });
    });
    $('#toolbar').load('toolbar.html');
    $('#moed_a').load('moed_a.html');
    $('#moed_b').load('moed_b.html');
    $('#courses').load('datatable.html', function () {
      $('#scheduler_function_caller').click(function(){
          $("[id^='exam_for_']").remove();
          console.log(localStorage);
          $('#exampleModal').modal("show");
          setTimeout(function () {
              $('#exampleModal').modal("hide");
              $.ajax({
                    url: "/make-schedule",
                    type: "POST",
                    data: JSON.stringify({
                        occupied: occupied,
                        semester: localStorage.semester_name,
                        faculty: localStorage.faculty_name
                    }),
                    success: fillScheduleWithCourses(["moed_a", "moed_b"])
              });
          }, 5000);
      });
      $('#scheduler_function_caller_2').click(function(){
          $("[id^='exam_for_moed_a']").remove();
          $.ajax({
              url: "/make-schedule",
              type: 'POST',
              data: JSON.stringify({
                  occupied: occupied,
                  semester: localStorage.semester_name,
                  faculty: localStorage.faculty_name
              }),
              success: fillScheduleWithCourses(["moed_a"]),
          });
      });
      $("#schedule_clear").click(function(){
          $("[id^='exam_for_']").remove();
      })
  });
    function initSched() {
        var top = document.getElementById('sem_picker');
        document.getElementById('semester_button').innerHTML = top.innerHTML;
        document.body.ondragover = function(ev) {
            ev.preventDefault();
        };
        document.body.ondrop = function(ev) {
            ev.preventDefault();
            var data = ev.dataTransfer.getData('list_drag');
            if (data != '') {
                document.body.removeChild(document.getElementById('test_tooltip_' + data));
            }
            data =  ev.dataTransfer.getData('test_drag');
            if (data != '') {
                var [id, temp] = str.split("|");
                document.body.removeChild(document.getElementById('test_tooltip_' + id));
            }
        };
    }
    window.addEventListener('load', initSched, false);
    function load_courses_table() {
        var table = $("#example").DataTable();
        table.clear().draw();
        var req1 = sendRequest("get", "/api/" + localStorage.getItem('semester_name') + "/course/list", null, function (res) {
            var courses = JSON.parse(res);
            for (var i in courses) {
                var pref = "אוטומטי";
                if (courses[i]["is_first"])
                    pref = "התחלה";
                if (courses[i]["is_last"])
                    pref = "סוף";
                var entry = {
                    "id": courses[i]["id"],
                    "name": courses[i]["name"],
                    "pref": pref,
                    "credit_points": courses[i]["credit_point"]["$numberDecimal"],
                    "days_before": courses[i]["days_before"],
                    "has_exam": courses[i]["has_exam"],
                    "is_first" : courses[i]["is_first"],
                    "is_last" : courses[i]["is_last"],
                };
                dict.push(entry);
                table.row.add(entry).draw();
            }
            localStorage.setItem("courses_dict",JSON.stringify(dict));
            table.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
                let a = this.node();
                this.node().draggable = true;
                this.node().className = "draggable";
                this.node().ondragstart = function (ev) {
                    var id = a.childNodes[1].innerHTML;
                    var test = document.createElement("label");
                    test.className += "test_tooltip";
                    test.innerHTML = id + " - " + a.childNodes[2].innerHTML;
                    test.draggable = true;
                    var color = "black";
                    if (id.startsWith("234")){
                        color = "#26A69A";
                    } else if (id.startsWith("104")){
                        color = "#EF5350";
                    } else if (id.startsWith("094")) {
                        color = "#FFEB3B";
                    } else if (id.startsWith("236")) {
                        color = "#9CCC65";
                    }
                    test.style.backgroundColor = color;
                    test.style.position = 'absolute';
                    test.style.left = '0px';
                    test.style.top = '0px';
                    test.style.zIndex = '-1';
                    test.id = 'test_tooltip_' + id;
                    document.body.appendChild(test);
                    ev.dataTransfer.setDragImage(test, 0, 0);
                    ev.dataTransfer.setData("list_drag", id);
                }
            } );
        });
    }
</script>
</body>
</html>
