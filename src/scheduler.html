<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-lite/1.1.0/material.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/dataTables.material.min.css">
    <script src="resources/jquery-3.3.1.js"></script>
    <link rel="stylesheet" href="resources/bootstrap.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.12/css/all.css" integrity="sha384-G0fIWCsCzJIMAVNQPfjH08cyYaUtMwjJwqiRKxxE/rx96Uroj1BtIQ6MLJuheaO9" crossorigin="anonymous">
    <link rel="stylesheet" href="resources/bootstrap-rtl.css">
    <script src="resources/bootstrap.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker3.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/locales/bootstrap-datepicker.he.min.js"></script>
    <link rel="shortcut icon" type="image/png" href="graphics/favicon.ico"/>
    <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.16/js/dataTables.material.min.js"></script>
    <script type="text/javascript" src="funcs.js"></script>
    <link rel="stylesheet" href="styles.css">

    <meta charset="utf-8">
    <title>Technion Exam Scheduler</title>
</head>
<body style="overflow-x: hidden;">
<div id="toolbar"></div>
<div class="dropdown navbar" style="padding: 0px;">
    <label class="dropdown-toggle" id="semester_button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-weight: bold; font-size: 32px; padding-right: 16px; padding-top: 10px;"></label>
    <div id= "sem_picker" class="dropdown-menu" aria-labelledby="semester_button" style="background-color: rgba(255,255,255,0.80); margin-right: 15px; width: 350px; margin-top: -5px;"></div>
</div>
<div class="form-group row" style="text-align: right; padding-right: 50px; padding-left: 50px; padding-top: 0px; margin-top: 0px !important;">
  <div class="container-fluid col">
    <div id="courses"></div>
  </div>
  <div class="container-fluid col">
    <div id="moed_a" moed="a"></div>
  </div>
  <div class="container-fluid col">
    <div id="moed_b" moed="b"></div>
  </div>
</div>
<div class="modal fade" data-backdrop="false" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document" style="margin-top: 90px;">
        <div class="modal-content" style="width: 440px;">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">בונה לוחות מבחנים</h5>
            </div>
            <div class="modal-body" align="center">
                <img src="graphics/load.gif">
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { sendRequest } from './js/request';
    var map_a = {};
    var map_b = {};
    sendRequest('GET', '/api/semester/list', null, function (res) {
        let semesters = JSON.parse(res);
        for (let i = semesters.length - 1; i >= 0; i--) {
            let semester = semesters[i].semester;
            if (semester == "spring") {
                semester = "אביב ";
            } else {
                semester = "חורף ";
            }
            let year = semesters[i].year.toString();
            let a = document.createElement("a");
            a.className = "dropdown-item";
            a.href = "#";
            a.innerHTML = 'סמסטר ' + semester + year + ' ';
            a.setAttribute('start_a', semesters[i].start_a);
            a.setAttribute('end_a', semesters[i].end_a);
            a.setAttribute('start_b', semesters[i].start_b);
            a.setAttribute('end_b', semesters[i].end_b);
            a.onclick = function () {
                document.getElementById('semester_button').innerHTML = a.innerHTML;
                map_a = make_calendar(new Date(a.getAttribute('start_a')), new Date(a.getAttribute('end_a')), "a");
                map_b = make_calendar(new Date(a.getAttribute('start_b')), new Date(a.getAttribute('end_b')), "b");
            };
            document.getElementById('sem_picker').appendChild(a);
        }
        var top = document.getElementById('sem_picker').firstChild;
        document.getElementById('semester_button').innerHTML = top.innerHTML;
        map_a = make_calendar(new Date(top.getAttribute('start_a')), new Date(top.getAttribute('end_a')), "a");
        map_b = make_calendar(new Date(top.getAttribute('start_b')), new Date(top.getAttribute('end_b')), "b");
    });
    $('#toolbar').load('toolbar.html');
    $('#moed_a').load('moed_a.html');
    $('#moed_b').load('moed_b.html');
    $('#courses').load('datatable.html', function () {
      $('#scheduler_function_caller').click(function(){
          $("[id^='exam_for_']").remove();
          console.log(occupied);
          $('#exampleModal').modal("show");
          setTimeout(function () {
              $('#exampleModal').modal("hide");
              $.ajax({url: "/make-schedule", type: "POST", data: JSON.stringify({occupied: occupied}), success: function(result){
                      result = JSON.parse(result);
                      for(var i = 0; i < result.moedA.length; i++){
                          var day = '#moed_a_day_' + result.moedA[i].index;
                          console.log(day);
                          for (var j = 0; j < result.moedA[i].exams.length; j++){
                              var test = document.createElement("div");
                              test.id = "exam_for_" + result.moedA[i].exams[j]["id"];
                              test.className = "test";
                              //test.style.margin = "2px 1px 2px 1px";
                              var id = result.moedA[i].exams[j]["id"];
                              var color = "#FFA726";
                              if (id.startsWith("234")){
                                  color = "#26A69A";
                              } else if (id.startsWith("104")){
                                  color = "#EF5350";
                              } else if (id.startsWith("094")) {
                                  color = "#FFEB3B";
                              } else if (id.startsWith("236")) {
                                  color = "#9CCC65";
                              }
                              test.style.backgroundColor = color;
                              test.style.width = "60px";
                              test.innerHTML = result.moedA[i].exams[j]["name"];
                              $(day).append(test);
                          }
                      }
                  for(var i = 0; i < result.moedB.length; i++){
                      var day = '#moed_b_day_' + result.moedB[i].index;
                      for (var j = 0; j < result.moedB[i].exams.length; j++){
                          var test = document.createElement("div");
                          test.id = "exam_for_" + result.moedB[i].exams[j]["id"];
                          test.className = "test";
                          //test.style.margin = "2px 1px 2px 1px";
                          var id = result.moedB[i].exams[j]["id"];
                          var color = "#FFA726";
                          if (id.startsWith("234")){
                              color = "#26A69A";
                          } else if (id.startsWith("104")){
                              color = "#EF5350";
                          } else if (id.startsWith("094")) {
                              color = "#FFEB3B";
                          } else if (id.startsWith("236")) {
                              color = "#9CCC65";
                          }
                          test.style.backgroundColor = color;
                          test.style.width = "60px";
                          test.innerHTML = result.moedB[i].exams[j]["name"];
                          $(day).append(test);
                      }
                  }
                  }
              });
          }, 5000);
          $("#schedule_clear").click(function(){
              $("[id^='exam_for_']").remove();
          });
      });
      $('#scheduler_function_caller_2').click(function(){
          $("[id^='exam_for_']").remove();
          $.ajax({url: "/make-schedule", type: 'POST', data: JSON.stringify({occupied: occupied}), success: function(result){
                  result = JSON.parse(result);
                  for(var i = 0; i < result.length; i++){
                      var day = '#moed_a_day_' + result[i].index;
                      for (var j = 0; j < result[i].exams.length; j++){
                          var test = document.createElement("div");
                          test.id = "exam_for_" + result[i].exams[j]["id"];
                          test.className = "test";
                          //test.style.margin = "2px 1px 2px 1px";
                          var id = result[i].exams[j]["id"];
                          var color = "#FFA726";
                          if (id.startsWith("234")){
                              color = "#26A69A";
                          } else if (id.startsWith("104")){
                              color = "#EF5350";
                          } else if (id.startsWith("094")) {
                              color = "#FFEB3B";
                          } else if (id.startsWith("236")) {
                              color = "#9CCC65";
                          }
                          test.style.backgroundColor = color;
                          test.style.width = "60px";
                          test.innerHTML = result[i].exams[j]["name"];
                          $(day).append(test);
                      }
                  }
              }
          });
          $("#schedule_clear").click(function(){
              $("[id^='exam_for_']").remove();
          })
      });
  });
    function initSched() {
        var top = document.getElementById('sem_picker');
        console.log(top);
        document.getElementById('semester_button').innerHTML = top.innerHTML;
    }
    window.addEventListener('load', initSched, false);

</script>
</body>
</html>
