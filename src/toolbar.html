<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.js"></script>
    <link rel="stylesheet" href="toolbar.css">
  <meta charset="UTF-8">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #343a40; padding: 0px; z-index: 101;">
    <span class="navbar-brand mb-0 h1" style="margin-left: 20px; font-size: 22px;">מערכת שיבוץ לוח מבחנים</span>
    <div class="btn-toolbar" id="button_toolbar" role="toolbar" aria-label="Toolbar with button groups">
      <div class="btn-group">
        <button id="message_button" type="button" class="btn btn-secondary btn-md" style="height: 40px; width: 110px; margin-left: 5px;">
            <i class="fas fa-envelope" style="padding-left: 5px"></i>
            הודעות
        </button>
      </div>
      <div class="btn-group">
        <button type="button" class="btn btn-secondary btn-md dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="height: 40px; width: 110px; margin-left: 5px;">
          <i class="fas fa-cloud" style="padding-left: 5px"></i>
          ענן
        </button>
        <div class="dropdown-menu dropdown-menu-right" style="margin-top: 14px;">
          <a class="dropdown-item" href="#" id="download_button">הורדה</a>
          <a class="dropdown-item" href="#" id="upload_button">העלאה</a>
        </div>
      </div>
      <div class="btn-group">
        <button type="button" class="btn btn-secondary btn-md dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="height: 40px; width: 110px; margin-left: 5px;">
          <i class="fas fa-truck" style="padding-left: 5px"></i>
          יצוא
        </button>
        <div class="dropdown-menu dropdown-menu-right" style="margin-top: 14px;">
          <a class="dropdown-item" href="#">בתור xls</a>
          <a class="dropdown-item" href="#">בתור txt</a>
          <a class="dropdown-item" id="png_export_button" href="#">בתור png</a>
        </div>
      </div>
    </div>
    <ul class="navbar-nav mr-auto">
      <li class="nav-item">
        <a id="faculty_name" class="nav-link" href="#" style="font-weight: normal; font-size: 16px;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <img id="faculty_image" height="45" width="45" style="border-radius: 50%; margin-right: 5px;">
        </a>
        <div class="dropdown-menu dropdown-menu-left" style="margin-top: 4px; margin-left:5px;">
          <a class="dropdown-item" href="#" id="email_change_button" style="height: 27.8px;">עדכון כתובת דוא"ל</a>
          <a class="dropdown-item" href="#" id="password_change_button" style="height: 27.8px;">עדכון סיסמה</a>
          <a class="dropdown-item" href="/logout" style="height: 27.8px;">התנתק</a>
        </div>
      </li>
    </ul>
  </nav>
  <div id="message_modal" class="modal right fade" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">הודעות</h5>
        </div>
        <div class="modal-body">
          <div id="accordion" role="tablist">
          </div>
        </div>
      </div>
    </div>
  </div>
  <script type="module">
      import {sendRequest} from "./js/request";
      document.getElementById('png_export_button').onclick = function(e) {
          html2canvas($("#master"),{
              onrendered: function(canvas) {
                  var a = document.createElement('a');
                  a.href = canvas.toDataURL("image/jpeg").replace("image/jpeg", "image/octet-stream");
                  a.download = 'exam_schedule.jpg';
                  a.click();
              }});
      };

    function formatDate(string) {
      let date = new Date(string);
      return date.getDay() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear();
    }

    function formatDateTime(string) {
      let date = new Date(string);
      return date.getHours() + ':' + date.getMinutes() + ' ' + date.getDay() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear();
    }

    function makeMessageCard(index, course, schedule, moed, messages) {
      let headerID = 'headeing_' + index.toString();
      let collapseID = 'collapse_' + index.toString();
      let message_textboxID = 'message_textbox_' + index.toString();
      let buttonID = 'message_button_' + index.toString();
      let card = '' +
      '              <div class="card-header" role="tab" id="' + headerID + '">\n' +
      '                <div data-toggle="collapse" href="#' + collapseID + '" aria-expanded="true" aria-controls="' + collapseID + '">\n' +
      '                  <div class="d-flex justify-content-between">\n' +
      '                    <h5 class="mb-0" style="text-align: right">' + course + ' (מואד ' + moed + ')</h5>\n' +
      '                    <p class="mb-0" style="text-align: right">תאריך: ' + formatDate(schedule) + '</p>\n' +
      '                  </div>\n' +
      '                </div>\n' +
      '              </div>\n' +
      '              <div id="' + collapseID + '" class="collapse" role="tabpanel" aria-labelledby="' + headerID + '" data-parent="#accordion">\n' +
      '                <ul class="list-group list-group-flush">\n';
      for (let i in messages) {
        card += '' +

        '                  <li class="list-group-item">\n' +
        '                    <div class="d-flex justify-content-between">\n' +
        '                      <h5 class="mb-0">' + messages[i].sender + '</h5>\n' +
        '                      <p class="mb-0">' + formatDateTime(messages[i].date) + '</p>\n' +
        '                    </div>\n' +
        '                    <p class="mb-0" style="text-align: right">' + messages[i].text + '</p>\n' +
        '                  </li>\n';
      }
      card += '' +
      '                  <li class="list-group-item">\n' +
      '                    <div class = "row">\n' +
      '                      <div class="col-10" style="padding-left: 0px; padding-right: 11px">\n' +
      '                        <textarea id="' + message_textboxID + '" rows = "2" type="text" style="resize: none;  font-size: 13px" class="form-control"></textarea>\n' +
      '                      </div>\n' +
      '                      <div class="col-2" style="padding-left: 11px; padding-right: 7px">\n' +
      '                        <button id="' + buttonID + '" class="btn btn-secondary" style="height: 100%; width: 100%;">\n' +
      '                          <i class="fas fa-flag"></i>\n' +
      '                        </button></div>\n' +
      '                    </div>\n' +
      '                  </li>';
      card += '' +
      '                </ul>\n' +
      '              </div>\n';
      let html = document.createElement('div');
      html.setAttribute('class', 'card');
      html.innerHTML = card;
      return html;
    }

    function sendMessage(event) {
      let text = document.getElementById(event.data.text_area).value;
      if (text.localeCompare('')) {
        let json = {
          course: event.data.course_id,
          message: text,
          moed: event.data.moed
        };
        let route = '/api/' + event.data.year + '-' + event.data.sem + '/message/send';
        sendRequest('post', route, json, () => {
          reload_message_list();
          $('#message_modal').modal('hide');
          document.getElementById(event.data.text_area).value = '';
        });
      }
    }

    function reload_message_list() {
      let accordion = document.getElementById('accordion');
      while (accordion.firstChild) {
        accordion.removeChild(accordion.firstChild);
      }
      sendRequest('get', '/api/message/list', null, res => {
        let data = JSON.parse(res);
        for (let i in data) {
          let course = data[i].course.name;
          let schedule_date = data[i].schedule;
          let moed = data[i].moed;
          if (!moed.localeCompare('A')) {
            moed = "א׳";
          } else {
            moed = "ב׳";
          }
          let messages = [];
          for (let j in data[i].messages) {
            messages.push({});
            messages[j].sender = data[i].messages[j].sender.name;
            messages[j].date = data[i].messages[j].date;
            messages[j].text = data[i].messages[j].text;
          }
          let card = makeMessageCard(i, course, schedule_date, moed, messages);
          document.getElementById('accordion').appendChild(card);
          $('#message_button_' + i).click({
            text_area: 'message_textbox_' + i,
            moed: data[i].moed,
            course_id: data[i].course.id,
            year: data[i].semester.year,
            sem: data[i].semester.semester
          }, sendMessage);
        }
      });
    }

    $(document).ready(reload_message_list);

    $('#message_button').click(() => {
      $('#message_modal').modal('show');
    });

      var name = localStorage.getItem('faculty_name');
      if (name == "Administrator") {
          name = "לימודי הסמכה";
          var sep = document.createElement('div');
          sep.className = "btn-group";
          sep.innerHTML = '        <div style="border-left:1px solid #000 ;width: 1px; height:40px; border-color: white; margin-left: 5px;"></div>\n';
          var mng = document.createElement('div');
          mng.className = "btn-group";
          mng.innerHTML = '<button type="button" class="btn btn-secondary btn-md dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="height: 40px; width: 110px; margin-left: 5px;">\n' +
              '          <i class="fas fa-pencil-alt" style="padding-left: 5px"></i>\n' +
              '          ניהול\n' +
              '        </button>\n' +
              '        <div class="dropdown-menu dropdown-menu-right" style="margin-top: 14px;)">\n' +
              '          <a class="dropdown-item" onclick="location.href=\'/faculties\'">פקולטות</a>\n' +
              '          <a class="dropdown-item" onclick="location.href=\'/semesters\'">מועדים</a>\n' +
              '          <a class="dropdown-item" id="course_management_item" data-toggle="modal" data-target="#courses_management_modal" href="#">קורסים</a>\n' +
              '        </div>';
          document.getElementById("button_toolbar").appendChild(sep);
          document.getElementById("button_toolbar").appendChild(mng);
      } else {
          name = "הפקולטה ל" + name;
      }
      document.getElementById("faculty_name").innerHTML = name + document.getElementById("faculty_name").innerHTML;
      document.getElementById("faculty_image").src = localStorage.getItem('faculty_image');
      var clean_button = document.getElementById("schedule_clear");
      clean_button.onclick = function(){
          function clean() {
              make_calendar(new Date(localStorage.getItem('start_a')), new Date(localStorage.getItem('end_a')), "a");
              make_calendar(new Date(localStorage.getItem('start_b')), new Date(localStorage.getItem('end_b')), "b");
          }
          popup_modal("CONF", 'האם אתה בטוח שברצונך לנקות את התוכנית?', clean);
      };

      var download_button = document.getElementById("download_button");
      download_button.onclick = function(){
          function download() {
              alert("download_constraints");
          }
          popup_modal("CONF", 'האם אתה בטוח שברצונך להוריד התנגשויות?', download);
      };


      var upload_button = document.getElementById("upload_button");
      upload_button.onclick = function(){
          $('#upload_modal').modal();

      };
      document.getElementById('email_change_button').onclick = function(e) {
          sendRequest('get', '/api/faculty/email', null, function (res) {
              let data = JSON.parse(res);
              document.getElementById('current_mail').innerHTML = data.email;
          });
          document.getElementById('email_change_error').innerHTML = "";
          document.getElementById('new_email').value = "";
          $('#email_change_modal').modal();
      }

      document.getElementById('password_change_button').onclick = function(e) {
          $('#password_change_modal').modal();
      }

      document.getElementById('course_management_item').onclick = function(e) {
          var manager = document.getElementById("new_course_faculty");
          var faculties_dict = JSON.parse(localStorage.getItem('faculties_dict'));
          for(var key in faculties_dict)
          {
              if (faculties_dict[key]["name"] == "Administrator")
                  continue;
              var option = document.createElement("option");
              option.innerHTML = faculties_dict[key]["name"];
              manager.appendChild(option);
          }
      }



  </script>
</body>
</html>
