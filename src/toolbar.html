<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="toolbar.css">
  <meta charset="UTF-8">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #343a40; padding: 0px;">
    <span class="navbar-brand mb-0 h1" style="margin-left: 20px; font-size: 22px;">מערכת שיבוץ לוח מבחנים</span>
    <div class="btn-toolbar" id="button_toolbar" role="toolbar" aria-label="Toolbar with button groups">
      <div class="btn-group">
        <button id="message_button" type="button" class="btn btn-secondary btn-md" style="height: 40px; width: 110px; margin-left: 5px;">
            <i class="fas fa-envelope" style="padding-left: 5px"></i>
            הודעות
        </button>
      </div>
      <div class="btn-group">
        <button type="button" class="btn btn-secondary btn-md dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="height: 40px; width: 110px; margin-left: 5px;">
          <i class="fas fa-cloud" style="padding-left: 5px"></i>
          ענן
        </button>
        <div class="dropdown-menu dropdown-menu-right" style="margin-top: 14px;">
          <a class="dropdown-item" href="#" id="download_button">הורדה</a>
          <a class="dropdown-item" href="#" id="upload_button">העלאה</a>
        </div>
      </div>
      <div class="btn-group">
        <button type="button" class="btn btn-secondary btn-md dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="height: 40px; width: 110px; margin-left: 5px;">
          <i class="fas fa-truck" style="padding-left: 5px"></i>
          יצוא
        </button>
        <div class="dropdown-menu dropdown-menu-right" style="margin-top: 14px;">
          <a class="dropdown-item" href="#">בתור Excel</a>
          <a class="dropdown-item" href="#">בתור XML</a>
          <a class="dropdown-item" href="#">בתור Calendar</a>
          <a class="dropdown-item" href="#">בתור PNG</a>
        </div>
      </div>
    </div>
    <ul class="navbar-nav mr-auto">
      <li class="nav-item">
        <a id="faculty_name" class="nav-link" href="#" style="font-weight: normal; font-size: 16px;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <img id="faculty_image" height="45" width="45" style="border-radius: 50%; margin-right: 5px;">
        </a>
        <div class="dropdown-menu dropdown-menu-left" style="margin-top: 4px; margin-left:5px;">
          <a class="dropdown-item" href="/edit_email">שינוי מייל</a>
          <a class="dropdown-item" href="/edit_password">שינוי סיסמה</a>
          <a class="dropdown-item" href="/logout">התנתק</a>
        </div>
      </li>
    </ul>
  </nav>
  <div id="message_modal" class="modal right fade" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">הודעות</h5>
        </div>
        <div class="modal-body">
          <div id="accordion" role="tablist">
            <!--<div class="card">-->
              <!--<div class="card-header" role="tab" id="headingOne">-->
                <!--<div data-toggle="collapse" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">-->
                  <!--<div class="d-flex justify-content-between">-->
                    <!--<h5 class="mb-0" style="text-align: right">Collapsible Group Item</h5>-->
                    <!--<p class="mb-0" style="text-align: right">Schedule: Tralala</p>-->
                  <!--</div>-->
                <!--</div>-->
              <!--</div>-->
              <!--<div id="collapseOne" class="collapse" role="tabpanel" aria-labelledby="headingOne" data-parent="#accordion">-->
                <!--<ul class="list-group list-group-flush">-->
                  <!--<li class="list-group-item">-->
                    <!--<div class="d-flex justify-content-between">-->
                      <!--<h5 class="mb-0">List group item heading</h5>-->
                      <!--<p class="mb-0">Date</p>-->
                    <!--</div>-->
                    <!--<p class="mb-0" style="text-align: right">Donec id elit non mi porta gravida at eget metus. Maecenas sed diam eget risus varius blandit.</p>-->
                  <!--</li>-->
                  <!--<li class="list-group-item">-->
                    <!--<div class = "row">-->
                      <!--<div class="col-10" style="padding-left: 0px; padding-right: 11px">-->
                        <!--<textarea id="popover_input" rows = "2" type="text" style="resize: none;  font-size: 13px" class="form-control"></textarea>-->
                      <!--</div>-->
                      <!--<div class="col-2" style="padding-left: 11px; padding-right: 7px">-->
                        <!--<button id="popover_button" class="btn btn-secondary" style=" ont-size: 13px; height: 100%; width: 100%;">-->
                          <!--<i class="fas fa-flag"></i>-->
                        <!--</button>-->
                      <!--</div>-->
                    <!--</div>-->
                  <!--</li>-->
                <!--</ul>-->
              <!--</div>-->
            <!--</div>-->
          </div>
        </div>
      </div>
    </div>
  </div>
  <script type="module">
    import {sendRequest} from "./js/request";

    function formatDate(string) {
      let date = new Date(string);
      return date.getDay() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear();
    }

    function formatDateTime(string) {
      let date = new Date(string);
      return date.getHours() + ':' + date.getMinutes() + ' ' + date.getDay() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear();
    }

    function makeMessageCard(index, course, schedule, messages) {
      let headerID = 'headeing_' + index.toString();
      let collapseID = 'collapse_' + index.toString();
      let message_textboxID = 'message_textbox_' + index.toString();
      let buttonID = 'message_button_' + index.toString();
      let card = '<div class="card">\n' +
      '              <div class="card-header" role="tab" id="' + headerID + '">\n' +
      '                <div data-toggle="collapse" href="#' + collapseID + '" aria-expanded="true" aria-controls="' + collapseID + '">\n' +
      '                  <div class="d-flex justify-content-between">\n' +
      '                    <h5 class="mb-0" style="text-align: right">' + course + '</h5>\n' +
      '                    <p class="mb-0" style="text-align: right">Schedule: ' + formatDate(schedule) + '</p>\n' +
      '                  </div>\n' +
      '                </div>\n' +
      '              </div>\n' +
      '              <div id="' + collapseID + '" class="collapse" role="tabpanel" aria-labelledby="' + headerID + '" data-parent="#accordion">\n' +
      '                <ul class="list-group list-group-flush">\n';
      for (let i in messages) {
        card += '' +

        '                  <li class="list-group-item">\n' +
        '                    <div class="d-flex justify-content-between">\n' +
        '                      <h5 class="mb-0">' + messages[i].sender + '</h5>\n' +
        '                      <p class="mb-0">' + formatDateTime(messages[i].date) + '</p>\n' +
        '                    </div>\n' +
        '                    <p class="mb-0" style="text-align: right">' + messages[i].text + '</p>\n' +
        '                  </li>\n';
      }
      card += '' +
      '                  <li class="list-group-item">\n' +
      '                    <div class = "row">\n' +
      '                      <div class="col-10" style="padding-left: 0px; padding-right: 11px">\n' +
      '                        <textarea id="' + message_textboxID + '" rows = "2" type="text" style="resize: none;  font-size: 13px" class="form-control"></textarea>\n' +
      '                      </div>\n' +
      '                      <div class="col-2" style="padding-left: 11px; padding-right: 7px">\n' +
      '                        <button id="' + buttonID + '" class="btn btn-secondary" style="height: 100%; width: 100%;">\n' +
      '                          <i class="fas fa-flag"></i>\n' +
      '                        </button></div>\n' +
      '                    </div>\n' +
      '                  </li>';
      card += '' +
      '                </ul>\n' +
      '              </div>\n' +
      '            </div>\n';
      return card;
    }

    function sendMessage(event) {
      let text = document.getElementById(event.data.text_area).value;
      if (text.localeCompare('')) {
        console.log(text);
        $('#message_modal').modal('hide');
        document.getElementById(event.data.text_area).value = '';
      }
    }

    sendRequest('get', '/api/message/list', null, res => {
      let data = JSON.parse(res);
      for (let i in data) {
        let course = data[i].course.name;
        let schedule_date = data[i].schedule;
        let messages = [];
        for (let j in data[i].messages) {
          messages.push({});
          messages[j].sender = data[i].messages[j].sender.name;
          messages[j].date = data[i].messages[j].date;
          messages[j].text = data[i].messages[j].text;
        }
        let card = makeMessageCard(i, course, schedule_date, messages);
        document.getElementById('accordion').innerHTML += card;
        $('#message_button_' + i.toString()).click({text_area: 'message_textbox_' + i.toString()}, sendMessage);
      }
    });

    $('#message_button').click(() => {
      $('#message_modal').modal('show');
    });



      var name = localStorage.getItem('faculty_name');
      if (name == "Administrator") {
          name = "לימודי הסמכה";
          var sep = document.createElement('div');
          sep.className = "btn-group";
          sep.innerHTML = '        <div style="border-left:1px solid #000 ;width: 1px; height:40px; border-color: white; margin-left: 5px;"></div>\n';
          var mng = document.createElement('div');
          mng.className = "btn-group";
          mng.innerHTML = '<button type="button" class="btn btn-secondary btn-md dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="height: 40px; width: 110px; margin-left: 5px;">\n' +
              '          <i class="fas fa-pencil-alt" style="padding-left: 5px"></i>\n' +
              '          ניהול\n' +
              '        </button>\n' +
              '        <div class="dropdown-menu dropdown-menu-right" style="margin-top: 14px;)">\n' +
              '          <a class="dropdown-item" onclick="location.href=\'/faculties\'">פקולטות</a>\n' +
              '          <a class="dropdown-item" onclick="location.href=\'/semesters\'">מועדים</a>\n' +
              '          <a class="dropdown-item" href="#">קורסים</a>\n' +
              '        </div>';
          document.getElementById("button_toolbar").appendChild(sep);
          document.getElementById("button_toolbar").appendChild(mng);
      } else {
          name = "הפקולטה ל" + name;
      }
      document.getElementById("faculty_name").innerHTML = name + document.getElementById("faculty_name").innerHTML;
      document.getElementById("faculty_image").src = localStorage.getItem('faculty_image');
      var clean_button = document.getElementById("schedule_clear");
      clean_button.onclick = function(){
          function clean() {
              make_calendar(new Date(localStorage.getItem('start_a')), new Date(localStorage.getItem('end_a')), "a");
              make_calendar(new Date(localStorage.getItem('start_b')), new Date(localStorage.getItem('end_b')), "b");
          }
          popup_modal("CONF", 'האם אתה בטוח שברצונך לנקות את התוכנית?', clean);
      };

      var download_button = document.getElementById("download_button");
      download_button.onclick = function(){
          function download() {
              alert("download_constraints");
          }
          popup_modal("CONF", 'האם אתה בטוח שברצונך להוריד התנגשויות?', download);
      };


      var upload_button = document.getElementById("upload_button");
      upload_button.onclick = function(){
          $('#upload_modal').modal();

      };
  </script>
</body>
</html>
